# study_bot.py
import json
import os
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

TOKEN = os.getenv('8053874219:AAH9vOBmy18Rr0V0w52xlmkgEQgK4vsfzUQ
')
ADMIN_ID = int(os.getenv('6430355266'))

DATA_FILE = 'data.json'
user_states = {}

def load_data():
    try:
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_data(data):
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

data = load_data()

def get_categories_keyboard():
    buttons = [[KeyboardButton(cat)] for cat in data.keys()]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True)

def get_admin_menu():
    return ReplyKeyboardMarkup([
        ["â• Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ", "ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù"]
    ], resize_keyboard=True)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id == ADMIN_ID:
        await update.message.reply_text("Ø£Ù‡Ù„Ø§Ù‹ Ø£Ø¯Ù…Ù†! Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±:", reply_markup=get_admin_menu())
    else:
        await update.message.reply_text("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª:", reply_markup=get_categories_keyboard())

async def handle_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text

    if user_id == ADMIN_ID:
        if text == "â• Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ":
            user_states[user_id] = "adding_category"
            await update.message.reply_text("Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        elif text == "ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù":
            user_states[user_id] = "selecting_category"
            await update.message.reply_text("Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù:", reply_markup=get_categories_keyboard())
        elif user_states.get(user_id) == "adding_category":
            category = text
            if category in data:
                await update.message.reply_text("Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.", reply_markup=get_admin_menu())
            else:
                data[category] = []
                save_data(data)
                await update.message.reply_text(f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ {category}.", reply_markup=get_admin_menu())
            user_states.pop(user_id)
        elif user_states.get(user_id) == "selecting_category" and text in data:
            context.user_data["selected_category"] = text
            user_states[user_id] = "waiting_file"
            await update.message.reply_text(f"Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ù„Ù Ù„Ø¥Ø¶Ø§ÙØªÙ‡ ØªØ­Øª Ø§Ù„ØªØµÙ†ÙŠÙ: {text}")
        elif text in data:
            files = data[text]
            if files:
                for file in files:
                    await update.message.reply_document(document=file["file_id"], caption=file["file_name"])
            else:
                await update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.")
    else:
        if text in data:
            files = data[text]
            if files:
                for file in files:
                    await update.message.reply_document(document=file["file_id"], caption=file["file_name"])
            else:
                await update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.")
        else:
            await update.message.reply_text("Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·.")

async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id != ADMIN_ID:
        return

    if user_states.get(user_id) == "waiting_file":
        document = update.message.document
        category = context.user_data.get("selected_category")
        if category:
            data[category].append({
                "file_id": document.file_id,
                "file_name": document.file_name
            })
            save_data(data)
            await update.message.reply_text(f"ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙ {category}.", reply_markup=get_admin_menu())
            user_states.pop(user_id)
        else:
            await update.message.reply_text("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹.")

def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_buttons))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    app.run_polling()

if __name__ == "__main__":
    main()
